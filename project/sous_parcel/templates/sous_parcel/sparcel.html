{% extends 'panel/base.html' %}
{% load static %}
{% block title %}Welcome | {% endblock %}

{% block content %}


<div class="container-fluid py-4">
    <div class="row">
 

        <div class="col">     <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin="" />

            <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==" crossorigin=""></script>
            
            <div id="map"></div></div>
          <div class="col-4 d-flex flex-column">
            <div class="col d-flex ">
                <div class="me-auto" id="soil">
                  <h1 class="display-1 font-weight-bold mt-n4 mb-0" id="value" >
                    
                  </h1>
                  <h6 class="text-uppercase mb-0 ms-1">Cloudy</h6>
                </div>
                <div class="ms-auto">
                  <img class="w-50 float-end mt-lg-n4" src="{% static 'img/small-logos/icon-sun-cloud.png'%}" alt="image sun">
                </div>
              </div>
            <div class="col d-flex ">
                  <div class="row">
                    <div class="col">
                      <div class="card">
                        <div class="card-header pb-0">
                          <div class="row">
                            <div class="col-lg-6 col-7">
                              <h6>Projects</h6>
                              <p class="text-sm mb-0">
                                <i class="fa fa-check text-info" aria-hidden="true"></i>
                                <span class="font-weight-bold ms-1">{{capters_list|length }} capters</span> click pour affiche en cart
                              </p>
                            </div>
                            <div class="col-lg-6 col-5 my-auto text-end">
                              <div class="dropdown float-lg-end pe-4">
                                <a class="cursor-pointer" id="dropdownTable" data-bs-toggle="dropdown" aria-expanded="false">
                                  <i class="fa fa-ellipsis-v text-secondary"></i>
                                </a>
                                <ul class="dropdown-menu px-2 py-3 ms-sm-n4 ms-n5" aria-labelledby="dropdownTable">
                                  <li><a class="dropdown-item border-radius-md" href="javascript:;">Action</a></li>
                                  <li><a class="dropdown-item border-radius-md" href="javascript:;">Another action</a></li>
                                  <li><a class="dropdown-item border-radius-md" href="javascript:;">Something else here</a></li>
                                </ul>
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="card-body px-0 pb-2">
                          <div class="table-responsive">
                            <table class="table align-items-center mb-0">
                              <thead>
                                <tr>
                                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Companies</th>
                                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Members</th>
                                  <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Budget</th>
                                  <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Completion</th>
                                </tr>
                              </thead>
                              <tbody>
                                {%for capter in capters_list%}
                                    
                                <tr>
                                  <td>
                                    <div class="d-flex px-2 py-1">
                                      <div class="d-flex flex-column justify-content-center">
                                        <h6 class="mb-0 text-sm">{{capter.name}}</h6>
                                      </div>
                                    </div>
                                  </td>
    
                                  <td class="align-middle text-center text-sm">
                                    <span class="text-xs font-weight-bold" id="{{capter.id}}">  </span>
                                  </td>
                                  <td class="align-middle text-center text-sm">
                                  </td>
                                </tr>
                                {% endfor %}
                             </tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                    </div>
                </div>

            </div>
          </div>
  </div>
</div>
<div class="col-lg-7">
    <div class="card z-index-2">
      <div class="card-header pb-0">
        <h6>Sales overview</h6>
        <p class="text-sm">
          <i class="fa fa-arrow-up text-success" aria-hidden="true"></i>
          <span class="font-weight-bold">4% more</span> in 2021
        </p>
      </div>
      <div class="card-body p-3">
        <div class="chart">
          <canvas id="chart-line" class="chart-canvas" style="display: block; box-sizing: border-box; height: 300px; width: 417.5px;" width="334" height="240"></canvas>
        </div>
      </div>
    </div>
  </div>
<!-- prettier-ignore -->

<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==" crossorigin=""></script>
<script>
  // All the code for the leaflet map will come here
const map = L.map('map').setView([{{sparcel.latitude}}, {{sparcel.longitude}}], 14,touchZoom = false);
const basemaps = {
    StreetView: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',   {attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}),
    Topography: L.tileLayer.wms('http://ows.mundialis.de/services/service?',   {layers: 'TOPO-WMS'}),
    Places: L.tileLayer.wms('http://ows.mundialis.de/services/service?', {layers: 'OSM-Overlay-WMS'})
  };
  
  
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors' }).addTo(map);
  const marker1 = L.marker([-37.699450, 176.279420]).bindPopup('Turquoise Bay Exmouth, Australia').addTo(map);

  L.control.layers(basemaps).addTo(map);
  basemaps.StreetView.addTo(map);

</script>

<script>
    var circle = L.circle([{{sparcel.latitude}}, {{sparcel.longitude}}], {
        color: 'red',
        fillColor: '#f03',
        fillOpacity: 0.5,
        radius: 500
    }).bindPopup('{{sparcel.name}}').addTo(map);
</script>

{{sparcel.id|json_script:"sparcel_id"}}
<script src="{% static 'js/plugins/chartjs.min.js'%}"></script>
<script>
  
    var ctx2 = document.getElementById("chart-line").getContext("2d");

    var gradientStroke1 = ctx2.createLinearGradient(0, 230, 0, 50);

    gradientStroke1.addColorStop(1, 'rgba(203,12,159,0.2)');
    gradientStroke1.addColorStop(0.2, 'rgba(72,72,176,0.0)');
    gradientStroke1.addColorStop(0, 'rgba(203,12,159,0)'); //purple colors

    var gradientStroke2 = ctx2.createLinearGradient(0, 230, 0, 50);
    gradientStroke2.addColorStop(1, 'rgba(20,23,39,0.2)');
    gradientStroke2.addColorStop(0.2, 'rgba(72,72,176,0.0)');
    gradientStroke2.addColorStop(0, 'rgba(20,23,39,0)'); //purple colors

    var mainChart =new Chart(ctx2, {
      type: "line",
      data: {
        labels: [],
        datasets: [{
            label: "",
            tension: 0.4,
            borderWidth: 0,
            pointRadius: 0,
            borderColor: "#cb0c9f",
            borderWidth: 3,
            backgroundColor: gradientStroke1,
            fill: true,
            data: [],
            maxBarThickness: 6

          },
          {
            label: "Websites",
            tension: 0.4,
            borderWidth: 0,
            pointRadius: 0,
            borderColor: "#3A416F",
            borderWidth: 3,
            backgroundColor: gradientStroke2,
            fill: true,
            data: [],
            maxBarThickness: 6
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false,
          }
        },
        interaction: {
          intersect: false,
          mode: 'index',
        },
        scales: {
          y: {
            grid: {
              drawBorder: false,
              display: true,
              drawOnChartArea: true,
              drawTicks: false,
              borderDash: [5, 5]
            },
            ticks: {
              display: true,
              padding: 10,
              color: '#0040ff',
              font: {
                size: 11,
                family: "Open Sans",
                style: 'normal',
                lineHeight: 2
              },
            }
          },
          x: {
            grid: {
              drawBorder: false,
              display: false,
              drawOnChartArea: false,
              drawTicks: false,
              borderDash: [5, 5]
            },
            ticks: {
              display: true,
              color: '#0040ff',
              padding: 20,
              font: {
                size: 11,
                family: "Open Sans",
                style: 'normal',
                lineHeight: 2
              },
            }
          },
        },
      },
    });    
</script>
<script type ="module">

    var capters = {{capters_list|safe}};
    console.log(capters);
    for (var i = 0; i <capters.length; i++) {
        console.log(capters[i].id);
        }
   
        fetch('{% url 'sous_parcel:capter_value' sparcel.id %}')
        .then(response => response.json())
        .then(data => {
            data.valeurs.forEach(datum => {
                if (datum.capteur_id == '1') {
                    mainChart.data.datasets[0].data.push(datum.content);
                    
                    mainChart.data.labels.push(datum.date_added.slice(17,20));
                } else if (datum.capteur_id == '2') {
                    mainChart.data.datasets[1].data.push(datum.content);
                }
                console.log(datum.date_added);
            });
            mainChart.update();
        });
        for (var i = 0; i <capters.length; i++) {
            mainChart.data.datasets[i].label = capters[i].name
                    }


 </script>

{% endblock %}

{%block scripts %}

 
            <script>
                const sparcel_id = JSON.parse(document.getElementById("sparcel_id").textContent);
                const sparcelsocket = new WebSocket(
                'ws://'
                + window.location.host
                +'/ws/'
                + sparcel_id
                +'/'
                );
                sparcelsocket.onmessage = function(e){
                    console.log(e.data);
                    const data = JSON.parse(e.data);
                    if(data.value){
                        if(data.captername == 'soil'){document.getElementById("value").innerHTML= data.value;}
                        console.log(data.capterid);
                      document.getElementById(data.capterid).innerHTML= data.value;
                    }else{
                        console.log('there is no value');
                    }
                }


            </script>
            
{% endblock %}
